# ============================================
# Deep Research From Scratch - Docker Compose
# ============================================

services:
  deep-research:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: deep-research-agent
    
    # Port mapping
    ports:
      - "8000:8000"
    
    # Environment variables from .env file
    env_file:
      - .env
    
    # Additional environment variables (override or add as needed)
    environment:
      - PYTHONUNBUFFERED=1
      - PORT=8000
    
    # Volume mounts
    volumes:
      # Persist generated reports
      - research_reports:/app/src/deep_research_from_scratch/files
    
    # Resource limits (adjust based on your system)
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 1G
    
    # Restart policy
    restart: unless-stopped
    
    # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # ============================================
  # Jupyter Notebook Service (Development Only)
  # ============================================
  jupyter:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: deep-research-jupyter
    
    # Override command to run Jupyter
    command: >
      jupyter notebook 
      --ip=0.0.0.0 
      --port=8888 
      --no-browser 
      --allow-root 
      --NotebookApp.token=''
      --NotebookApp.password=''
    
    ports:
      - "8888:8888"
    
    env_file:
      - .env
    
    environment:
      - PYTHONUNBUFFERED=1
    
    volumes:
      # Mount notebooks for editing
      - ./notebooks:/app/notebooks
      # Persist generated reports
      - research_reports:/app/src/deep_research_from_scratch/files
    
    # This service is for development only
    profiles:
      - dev
    
    deploy:
      resources:
        limits:
          memory: 4G
        reservations:
          memory: 1G

# Named volumes for data persistence
volumes:
  research_reports:
    driver: local
